<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Chat</title>
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <style>
        :root{--bg-color:#f0f2f5;--container-bg:#fff;--sidebar-bg:#e4e6eb;--input-bg:#f0f2f5;--hover-bg:#d8dadf;--text-color:#050505;--secondary-text:#65676b;--accent-color:#0084ff;--accent-text:#fff;--border-color:#ced0d4;--system-msg-color:#65676b;--error-msg-color:#fa383e;--my-message-bg:#0084ff;--my-message-text:#fff;--other-message-bg:#e4e6eb;--other-message-text:#050505;--typing-color:#65676b;--link-color:#0e71c4;--avatar-size:32px}*,*::before,*::after{box-sizing:border-box}body{margin:0;font-family:Segoe UI Historic,Segoe UI,Helvetica,Arial,sans-serif;background-color:var(--bg-color);color:var(--text-color);display:flex;height:100vh;overflow:hidden}#sidebar{width:250px;min-width:200px;background-color:var(--sidebar-bg);border-right:1px solid var(--border-color);display:flex;flex-direction:column;height:100%}#room-selection{padding:1rem;border-bottom:1px solid var(--border-color)}#room-selection label{font-weight:700;margin-bottom:.5rem;display:block}#room-input{width:calc(100% - 80px);padding:.5rem;border:1px solid var(--border-color);border-radius:4px;margin-right:5px}#join-room-button{padding:.5rem .8rem;background-color:var(--accent-color);color:var(--accent-text);border:none;border-radius:4px;cursor:pointer}#join-room-button:disabled{background-color:#a0c7e4;cursor:not-allowed}#user-list-container{flex-grow:1;display:flex;flex-direction:column;overflow:hidden}#user-list-container h2{margin:0;padding:.8rem 1rem;font-size:.9em;font-weight:600;color:var(--secondary-text);border-bottom:1px solid var(--border-color);text-align:center;text-transform:uppercase;letter-spacing:.5px}#users{list-style-type:none;margin:0;padding:.5rem 1rem;overflow-y:auto;flex-grow:1}#users li{padding:.4rem 0;display:flex;align-items:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:.95em}.user-avatar{width:24px;height:24px;border-radius:50%;background-color:#ccc;color:#fff;display:inline-flex;align-items:center;justify-content:center;font-size:.8em;font-weight:700;margin-right:8px;flex-shrink:0}#chat-container{display:flex;flex-direction:column;flex-grow:1;background-color:var(--container-bg);height:100%}#chat-header{padding:.75rem 1rem;border-bottom:1px solid var(--border-color);font-weight:700;display:flex;justify-content:space-between;align-items:center}#chat-header span{flex-grow:1}#sound-toggle{font-size:.8em;cursor:pointer;padding:5px;border-radius:4px}#sound-toggle:hover{background-color:var(--hover-bg)}#sound-toggle.sound-on::before{content:'ðŸ”Š';margin-right:4px}#sound-toggle.sound-off::before{content:'ðŸ”‡';margin-right:4px}#messages{list-style-type:none;margin:0;padding:1rem;overflow-y:auto;flex-grow:1}#messages>li{margin-bottom:.25rem;position:relative}.message-container{display:flex;margin-bottom:.75rem;align-items:flex-start}.message-container.my-message{justify-content:flex-end}.message-container.other-message{justify-content:flex-start}.message-container.my-message .message-content{align-items:flex-end}.message-container.other-message .message-content{align-items:flex-start}.message-container .user-avatar{width:var(--avatar-size);height:var(--avatar-size);margin-top:5px}.message-container.my-message .user-avatar{margin-left:8px;order:2}.message-container.other-message .user-avatar{margin-right:8px;order:1}.message-content{display:flex;flex-direction:column;order:1}.message-container.my-message .message-content{order:1}.message-container.other-message .message-content{order:2}.message-bubble{padding:.5rem .8rem;border-radius:1rem;word-wrap:break-word;position:relative;min-width:50px}.message-container.my-message .message-bubble{background:var(--my-message-bg);color:var(--my-message-text);border-bottom-right-radius:.25rem}.message-container.other-message .message-bubble{background:var(--other-message-bg);color:var(--other-message-text);border-bottom-left-radius:.25rem}.message-meta{font-size:.8em;color:var(--secondary-text);margin-bottom:.25rem;padding:0 .2rem}.message-container.my-message .message-meta{text-align:right}.message-container.other-message .message-meta{text-align:left}.message-timestamp{margin-left:5px}#messages>li.message-status,#messages>li.message-system,#messages>li.message-error{color:var(--system-msg-color);font-style:italic;text-align:center;background:0 0;max-width:100%;font-size:.85em;margin:.5rem 0}#messages>li.message-error{color:var(--error-msg-color);font-weight:700;font-style:normal}#typing-indicator{padding:.25rem 1rem;height:1.5em;font-style:italic;color:var(--typing-color);font-size:.9em;text-align:left}#input-area{display:flex;align-items:center;padding:.75rem;border-top:1px solid var(--border-color);background-color:var(--container-bg)}#emoji-button{background:0 0;border:none;font-size:1.5rem;cursor:pointer;padding:0 .5rem;margin-right:.5rem;color:var(--secondary-text)}#emoji-button:hover{color:var(--text-color)}#emoji-button:disabled{cursor:not-allowed;color:#ccc}#input{border:1px solid var(--border-color);background-color:var(--input-bg);padding:.75rem 1rem;flex-grow:1;border-radius:1.5rem;margin-right:.5rem;resize:none;line-height:1.4}#input:focus{outline:0;border-color:var(--accent-color);background-color:var(--container-bg)}#input:disabled{background-color:#f8f9fa;cursor:not-allowed}#input-area button[type=submit]{background:var(--accent-color);border:none;padding:.75rem 1.5rem;border-radius:1.5rem;outline:0;color:var(--accent-text);cursor:pointer;font-weight:700;transition:background-color .2s ease}#input-area button[type=submit]:hover{background:#0073e6}#input-area button[type=submit]:disabled{background-color:#a0c7e4;cursor:not-allowed}#username-modal{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.6);display:flex;justify-content:center;align-items:center;z-index:1000}#username-prompt{background:#fff;padding:2rem;border-radius:8px;text-align:center;box-shadow:0 4px 15px rgba(0,0,0,.2);min-width:300px}#username-prompt h2{margin-top:0;margin-bottom:1rem}#username-input{padding:.6rem;margin:.5rem 0;width:90%;border:1px solid #ccc;border-radius:4px}#username-button{padding:.7rem 1.5rem;cursor:pointer;background-color:var(--accent-color);color:var(--accent-text);border:none;border-radius:4px;font-weight:700}#username-error{color:var(--error-msg-color);font-size:.9em;height:1.2em;margin-top:.5em}emoji-picker{position:absolute;bottom:60px;left:10px;z-index:1001}
    </style>
</head>
<body>
    <div id="username-modal">
        <div id="username-prompt">
            <h2>Enter Your Username</h2>
            <input type="text" id="username-input" placeholder="Username" autofocus maxlength="20">
            <button id="username-button">Enter Chat</button>
            <div id="username-error"></div>
        </div>
    </div>

    <div id="sidebar">
        <div id="room-selection">
            <label for="room-input">Room:</label>
            <input type="text" id="room-input" value="general" placeholder="Enter room name" disabled>
            <button id="join-room-button" disabled>Join</button>
        </div>
        <div id="user-list-container">
            <h2 id="user-list-header">Online Users</h2>
            <ul id="users"></ul>
        </div>
    </div>

    <div id="chat-container">
         <div id="chat-header">
            <span id="current-room-name">Not in a room</span>
            <span id="sound-toggle" class="sound-off" title="Toggle sound notifications">Muted</span>
         </div>
        <ul id="messages"></ul>
        <div id="typing-indicator"></div>
         <emoji-picker style="display: none;"></emoji-picker>
        <form id="input-area" action="">
            <button type="button" id="emoji-button" title="Pick emoji" disabled>ðŸ˜€</button>
            <input id="input" autocomplete="off" placeholder="Type a message..." disabled />
            <button type="submit" id="send-button" disabled>Send</button>
        </form>
    </div>

    <audio id="notification-sound" src="https://cdn.freesound.org/previews/253/253886_313295-lq.mp3" preload="auto"></audio>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const TYPING_TIMER_LENGTH = 800;
        const TYPING_DISPLAY_TIMER_LENGTH = 2500;
        const HASH_COLOR_COUNT = 18;
        const AVATAR_COLORS = ["#ff7f0e","#1f77b4","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf","#aec7e8","#ffbb78","#98df8a","#ff9896","#c5b0d5","#c49c94","#f7b6d2","#c7c7c7"];

        const messagesContainer=document.getElementById('messages'); const messageInputForm=document.getElementById('input-area'); const messageInput=document.getElementById('input'); const sendButton=document.getElementById('send-button'); const userList=document.getElementById('users'); const userListHeader=document.getElementById('user-list-header'); const typingIndicator=document.getElementById('typing-indicator'); const usernameModal=document.getElementById('username-modal'); const usernameInput=document.getElementById('username-input'); const usernameButton=document.getElementById('username-button'); const usernameError=document.getElementById('username-error'); const roomInput=document.getElementById('room-input'); const joinRoomButton=document.getElementById('join-room-button'); const currentRoomNameSpan=document.getElementById('current-room-name'); const emojiButton=document.getElementById('emoji-button'); const emojiPicker=document.querySelector('emoji-picker'); const soundToggle=document.getElementById('sound-toggle'); const notificationSound=document.getElementById('notification-sound');

        let currentUsername=null; let currentRoom=null; let isTyping=false; let lastTypingTime; let usersTyping={}; let soundEnabled=false; let isWindowFocused=true;

        const socket=io({reconnectionAttempts:5,reconnectionDelay:2e3,timeout:1e4});

        function getUserInitials(username){if(!username)return"?";const parts=username.split(/[ _-]/);return parts.length===1?username.substring(0,2).toUpperCase():(parts[0][0]+(parts[1]?parts[1][0]:"")).toUpperCase()}
        function getAvatarColor(username){let hash=0;if(!username)return AVATAR_COLORS[0];for(let i=0;i<username.length;i++){hash=username.charCodeAt(i)+((hash<<5)-hash);hash=hash&hash}return AVATAR_COLORS[Math.abs(hash)%AVATAR_COLORS.length]}
        function createUserAvatar(username){const avatar=document.createElement('div');avatar.className="user-avatar";avatar.style.backgroundColor=getAvatarColor(username);avatar.textContent=getUserInitials(username);avatar.title=username;return avatar}
        function escapeHTML(str){if(typeof str!=="string")return"";const div=document.createElement('div');div.appendChild(document.createTextNode(str));return div.innerHTML}
        function formatMessageContent(text){const urlRegex=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;return text.replace(urlRegex,url=>`<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: var(--link-color);">${url}</a>`)}
        function scrollToBottom(){messagesContainer.scrollTop=messagesContainer.scrollHeight}
        function playNotificationSound(){if(notificationSound.readyState>=2){notificationSound.currentTime=0;notificationSound.play().catch(error=>console.warn("Sound play failed:",error))}}
        function updateSoundToggleUI(){soundToggle.className=soundEnabled?'sound-on':'sound-off';soundToggle.textContent=soundEnabled?'Sound ON':'Sound OFF';soundToggle.title=soundEnabled?'Click to Mute':'Click to Unmute'}
        function enableChatInterface(){messageInput.disabled=false;sendButton.disabled=false;emojiButton.disabled=false;if(!currentRoom){roomInput.disabled=false;joinRoomButton.disabled=false;roomInput.focus()}else{messageInput.focus()}}
        function disableChatInterface(){messageInput.disabled=true;sendButton.disabled=true;emojiButton.disabled=true;roomInput.disabled=true;joinRoomButton.disabled=true;emojiPicker.style.display='none'}

        function addMessage(data,isHistory=false){const{msg,username,timestamp,type='user',room}=data;if(room&&room!==currentRoom)return;const messageElement=document.createElement('li');messageElement.classList.add(`message-${type}`);if(type==='user'){const messageContainer=document.createElement('div');messageContainer.classList.add('message-container');const isMyMsg=username===currentUsername;messageContainer.classList.add(isMyMsg?'my-message':'other-message');const avatarElement=createUserAvatar(username);const messageContent=document.createElement('div');messageContent.classList.add('message-content');const metaSpan=document.createElement('span');metaSpan.classList.add('message-meta');metaSpan.textContent=`${username} - ${timestamp||''}`;const bubbleSpan=document.createElement('span');bubbleSpan.classList.add('message-bubble');bubbleSpan.innerHTML=formatMessageContent(escapeHTML(msg));messageContent.appendChild(metaSpan);messageContent.appendChild(bubbleSpan);messageContainer.appendChild(avatarElement);messageContainer.appendChild(messageContent);messageElement.appendChild(messageContainer);if(!isHistory&&!isMyMsg&&soundEnabled&&!isWindowFocused){playNotificationSound()}}else{messageElement.innerHTML=`<span class="message-text">${escapeHTML(msg)}</span> <span class="message-timestamp">${timestamp||''}</span>`}messagesContainer.appendChild(messageElement);const shouldScroll=isHistory||(username===currentUsername)||(messagesContainer.scrollTop+messagesContainer.clientHeight>=messagesContainer.scrollHeight-150);if(shouldScroll){scrollToBottom()}}
        function loadMessageHistory(history){messagesContainer.innerHTML='';if(history&&history.length>0){addMessage({type:'system',msg:`--- Displaying last ${history.length} messages ---`,timestamp:''});history.forEach(msgData=>addMessage(msgData,true))}else{addMessage({type:'system',msg:'No previous messages in this room.',timestamp:''})}scrollToBottom()}
        function updateUserList(usernames){userList.innerHTML='';usernames.sort((a,b)=>a.toLowerCase().localeCompare(b.toLowerCase()));usernames.forEach(username=>{const item=document.createElement('li');const avatar=createUserAvatar(username);const nameSpan=document.createElement('span');nameSpan.textContent=escapeHTML(username);item.appendChild(avatar);item.appendChild(nameSpan);userList.appendChild(item)});userListHeader.textContent=`Online Users (${usernames.length})`}
        function updateTypingIndicator(){const typingUsernames=Object.values(usersTyping).map(u=>u.username);if(typingUsernames.length===0){typingIndicator.textContent=''}else if(typingUsernames.length===1){typingIndicator.textContent=`${escapeHTML(typingUsernames[0])} is typing...`}else if(typingUsernames.length===2){typingIndicator.textContent=`${escapeHTML(typingUsernames[0])} and ${escapeHTML(typingUsernames[1])} are typing...`}else{typingIndicator.textContent='Several people are typing...'}}

        usernameButton.addEventListener('click',()=>{const username=usernameInput.value.trim();if(username){currentUsername=username;usernameError.textContent='';usernameModal.style.display='none';enableChatInterface();joinRoom(roomInput.value.trim().toLowerCase()||'general')}else{usernameError.textContent='Please enter a valid username.'}});
        usernameInput.addEventListener('keypress',e=>{if(e.key==='Enter'){usernameButton.click()}});
        joinRoomButton.addEventListener('click',()=>{const roomName=roomInput.value.trim().toLowerCase();if(roomName&Â¤tUsername){joinRoom(roomName)}else if(!currentUsername){alert("Please set username first.")}else{alert("Please enter room name.")}});
        roomInput.addEventListener('keypress',e=>{if(e.key==='Enter'){joinRoomButton.click()}});
        messageInputForm.addEventListener('submit',e=>{e.preventDefault();const messageText=messageInput.value.trim();if(messageText&Â¤tUsername&Â¤tRoom){socket.emit('send_message',{msg:messageText});messageInput.value='';if(isTyping){socket.emit('typing',{is_typing:false});isTyping=false}messageInput.focus()}});
        messageInput.addEventListener('input',()=>{if(!currentUsername||!currentRoom)return;if(!isTyping){isTyping=true;socket.emit('typing',{is_typing:true})}lastTypingTime=Date.now();setTimeout(()=>{if(isTyping&&(Date.now()-lastTypingTime>=TYPING_TIMER_LENGTH)){socket.emit('typing',{is_typing:false});isTyping=false}},TYPING_TIMER_LENGTH)});
        emojiButton.addEventListener('click',e=>{e.stopPropagation();emojiPicker.style.display=emojiPicker.style.display==='none'?'block':'none'});
        emojiPicker.addEventListener('emoji-click',event=>{messageInput.value+=event.detail.unicode;emojiPicker.style.display='none';messageInput.focus()});
        document.addEventListener('click',event=>{if(emojiPicker.style.display!=='none'&&!emojiPicker.contains(event.target)&&event.target!==emojiButton){emojiPicker.style.display='none'}});
        soundToggle.addEventListener('click',()=>{soundEnabled=!soundEnabled;updateSoundToggleUI();if(soundEnabled){playNotificationSound()}});
        window.addEventListener('focus',()=>{isWindowFocused=true});window.addEventListener('blur',()=>{isWindowFocused=false});

        function joinRoom(roomName){if(!currentUsername||!roomName)return;console.log(`Attempting to join room: ${roomName} as ${currentUsername}`);messagesContainer.innerHTML='';userList.innerHTML='';userListHeader.textContent='Online Users';typingIndicator.textContent='';currentRoom=null;currentRoomNameSpan.textContent=`Joining ${roomName}...`;disableChatInterface();socket.emit('join_room',{username:currentUsername,room:roomName})}
        socket.on('connect',()=>{console.log('Connected:',socket.id);if(!currentUsername){usernameModal.style.display='flex';disableChatInterface();usernameInput.focus()}else{const roomToRejoin=(roomInput.value.trim().toLowerCase()||'general');console.log(`Reconnected. Rejoining: ${roomToRejoin}`);joinRoom(roomToRejoin)}});
        socket.on('disconnect',reason=>{console.log('Disconnected:',reason);addMessage({type:'error',msg:`Disconnected: ${reason}. Reconnecting...`,timestamp:''});userList.innerHTML='<li><i>Disconnected</i></li>';userListHeader.textContent='Offline';typingIndicator.textContent='';usersTyping={};currentRoomNameSpan.textContent="Disconnected";currentRoom=null;disableChatInterface()});
        socket.on('connect_error',err=>{console.error('Connection Error:',err);addMessage({type:'error',msg:`Connection failed: ${err.message}.`,timestamp:''});if(usernameModal.style.display==='flex'){usernameError.textContent=`Connection Failed`}disableChatInterface()});
        socket.on('room_joined',(data)=>{const{username,room,history}=data;console.log(`Joined room: ${room}`);if(username===currentUsername){currentRoom=room;currentRoomNameSpan.textContent=`Room: ${room}`;roomInput.value=room;loadMessageHistory(history);enableChatInterface();messageInput.focus()}else{console.warn("Received room_joined for unexpected user:",username)}});
        socket.on('error',data=>{console.error('Server Error:',data.msg);addMessage({type:'error',msg:`Error: ${data.msg}`,timestamp:''});if(!currentRoom&Â¤tUsername){enableChatInterface();currentRoomNameSpan.textContent="Error Joining"}if(usernameModal.style.display==='flex'){usernameError.textContent=data.msg}});
        socket.on('receive_message',data=>{if(data.room===currentRoom){addMessage(data);if(data.username&&usersTyping[data.username]){clearTimeout(usersTyping[data.username].timeoutId);delete usersTyping[data.username];updateTypingIndicator()}}});
        socket.on('update_user_list',data=>{if(data.room===currentRoom){updateUserList(data.users)}});
        socket.on('user_typing',data=>{if(data.room===currentRoom&&data.username!==currentUsername){const{username,is_typing}=data;if(is_typing){if(usersTyping[username]){clearTimeout(usersTyping[username].timeoutId)}usersTyping[username]={username:username,timeoutId:setTimeout(()=>{delete usersTyping[username];updateTypingIndicator()},TYPING_DISPLAY_TIMER_LENGTH)}}else{if(usersTyping[username]){clearTimeout(usersTyping[username].timeoutId);delete usersTyping[username]}}updateTypingIndicator()}});

        function initializeApp(){disableChatInterface();updateSoundToggleUI();usernameModal.style.display='flex';usernameInput.focus()}
        initializeApp();
    </script>
</body>
</html>
