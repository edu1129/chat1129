<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Chat Rooms</title>
    <!-- Emoji Picker Element -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --container-bg: #ffffff;
            --sidebar-bg: #e4e6eb;
            --input-bg: #f0f2f5;
            --hover-bg: #d8dadf;
            --text-color: #050505;
            --secondary-text: #65676b;
            --accent-color: #0084ff;
            --accent-text: #ffffff;
            --border-color: #ced0d4;
            --system-msg-color: #65676b;
            --error-msg-color: #fa383e;
            --my-message-bg: #0084ff;
            --my-message-text: #ffffff;
            --other-message-bg: #e4e6eb;
            --other-message-text: #050505;
            --typing-color: #65676b;
            --link-color: #0e71c4;
            --avatar-size: 32px;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: Segoe UI Historic, Segoe UI, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        #sidebar {
            width: 250px;
            min-width: 200px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        #room-selection {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        #room-selection label { font-weight: bold; margin-bottom: 0.5rem; display: block; }
        #room-input { width: calc(100% - 80px); padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; margin-right: 5px;}
        #join-room-button { padding: 0.5rem 0.8rem; background-color: var(--accent-color); color: var(--accent-text); border: none; border-radius: 4px; cursor: pointer;}
        #join-room-button:disabled { background-color: #a0c7e4; cursor: not-allowed; }

        #user-list-container {
             flex-grow: 1;
             display: flex;
             flex-direction: column;
             overflow: hidden;
        }

        #user-list-container h2 {
            margin: 0;
            padding: 0.8rem 1rem;
            font-size: 0.9em;
            font-weight: 600;
            color: var(--secondary-text);
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #users {
            list-style-type: none;
            margin: 0;
            padding: 0.5rem 1rem;
            overflow-y: auto;
            flex-grow: 1;
        }

        #users li {
            padding: 0.4rem 0;
            display: flex;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.95em;
        }

        .user-avatar {
            width: 24px; height: 24px;
            border-radius: 50%;
            background-color: #ccc; /* Placeholder */
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
            margin-right: 8px;
            flex-shrink: 0;
        }

        #chat-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            background-color: var(--container-bg);
            height: 100%;
        }

         #chat-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
         }
         #chat-header span { flex-grow: 1; }
         #sound-toggle { font-size: 0.8em; cursor: pointer; padding: 5px; border-radius: 4px; }
         #sound-toggle:hover { background-color: var(--hover-bg); }
         #sound-toggle.sound-on::before { content: 'ðŸ”Š'; margin-right: 4px;}
         #sound-toggle.sound-off::before { content: 'ðŸ”‡'; margin-right: 4px;}

        #messages {
            list-style-type: none;
            margin: 0;
            padding: 1rem;
            overflow-y: auto;
            flex-grow: 1;
        }

        #messages > li {
            padding: 0.5rem 0.8rem;
            margin-bottom: 0.25rem; /* Reduced margin */
            border-radius: 1rem;
            word-wrap: break-word;
            max-width: 75%; /* Limit message width */
            display: flex;
            flex-direction: column;
            position: relative; /* For timestamp positioning */
        }

        .message-container {
            display: flex;
            margin-bottom: 0.75rem; /* Space between message groups */
            align-items: flex-start; /* Align avatar with top of message */
        }

        .message-container.my-message { justify-content: flex-end; }
        .message-container.other-message { justify-content: flex-start; }

        .message-container.my-message .message-content { align-items: flex-end; } /* Align items to the right */
        .message-container.other-message .message-content { align-items: flex-start; } /* Align items to the left */

        .message-container .user-avatar {
            width: var(--avatar-size); height: var(--avatar-size);
            margin-top: 5px; /* Align with first line roughly */
        }
        .message-container.my-message .user-avatar { margin-left: 8px; order: 2; } /* Avatar on right */
        .message-container.other-message .user-avatar { margin-right: 8px; order: 1; } /* Avatar on left */

        .message-content {
            display: flex;
            flex-direction: column;
            order: 1; /* Content first by default */
        }
        .message-container.my-message .message-content { order: 1; }
        .message-container.other-message .message-content { order: 2; }


        .message-bubble {
            padding: 0.5rem 0.8rem;
            border-radius: 1rem;
            word-wrap: break-word;
            max-width: 100%; /* Let container limit width */
            position: relative;
            min-width: 50px; /* Ensure small messages look ok */
        }

        .message-container.my-message .message-bubble { background: var(--my-message-bg); color: var(--my-message-text); border-bottom-right-radius: 0.25rem;}
        .message-container.other-message .message-bubble { background: var(--other-message-bg); color: var(--other-message-text); border-bottom-left-radius: 0.25rem;}


        .message-meta {
            font-size: 0.8em;
            color: var(--secondary-text);
            margin-bottom: 0.25rem;
            padding: 0 0.2rem; /* Padding for alignment */
        }
        .message-container.my-message .message-meta { text-align: right; }
        .message-container.other-message .message-meta { text-align: left; }
        .message-timestamp { margin-left: 5px; }


        /* Status and Error Messages (centered) */
        #messages > li.message-status,
        #messages > li.message-system,
        #messages > li.message-error {
            color: var(--system-msg-color);
            font-style: italic; text-align: center;
            background: none; max-width: 100%;
            font-size: 0.85em;
            margin: 0.5rem 0; /* More vertical space for status */
        }
        #messages > li.message-error {
            color: var(--error-msg-color);
            font-weight: bold; font-style: normal;
        }


        #typing-indicator {
            padding: 0.25rem 1rem;
            height: 1.5em; /* Reserve space */
            font-style: italic;
            color: var(--typing-color);
            font-size: 0.9em;
            text-align: left;
        }

        #input-area {
            display: flex;
            align-items: center; /* Vertically align items */
            padding: 0.75rem;
            border-top: 1px solid var(--border-color);
            background-color: var(--container-bg); /* Match chat background */
        }

        #emoji-button {
             background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0 0.5rem;
             margin-right: 0.5rem; color: var(--secondary-text);
        }
         #emoji-button:hover { color: var(--text-color); }
         #emoji-button:disabled { cursor: not-allowed; color: #ccc; }

        #input {
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            padding: 0.75rem 1rem;
            flex-grow: 1;
            border-radius: 1.5rem;
            margin-right: 0.5rem;
            resize: none; /* Prevent manual resize if it was a textarea */
            line-height: 1.4;
        }
        #input:focus { outline: none; border-color: var(--accent-color); background-color: var(--container-bg); }
        #input:disabled { background-color: #f8f9fa; cursor: not-allowed; }

        #input-area button[type="submit"] {
            background: var(--accent-color);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 1.5rem;
            outline: none;
            color: var(--accent-text);
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s ease;
        }
        #input-area button[type="submit"]:hover { background: #0073e6; }
        #input-area button[type="submit"]:disabled { background-color: #a0c7e4; cursor: not-allowed;}

        /* Username Prompt */
        #username-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
        }
        #username-prompt {
            background: white; padding: 2rem; border-radius: 8px; text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); min-width: 300px;
        }
        #username-prompt h2 { margin-top: 0; margin-bottom: 1rem;}
        #username-input { padding: 0.6rem; margin: 0.5rem 0; width: 90%; border: 1px solid #ccc; border-radius: 4px;}
        #username-button { padding: 0.7rem 1.5rem; cursor: pointer; background-color: var(--accent-color); color: var(--accent-text); border: none; border-radius: 4px; font-weight: bold;}
        #username-error { color: var(--error-msg-color); font-size: 0.9em; height: 1.2em; margin-top: 0.5em;}

        /* Emoji Picker Styling (Optional - Adjust if needed) */
        emoji-picker { position: absolute; bottom: 60px; /* Adjust based on input area height */ left: 10px; z-index: 1001; }

    </style>
</head>
<body>

    <!-- Initial Username Prompt -->
    <div id="username-modal">
        <div id="username-prompt">
            <h2>Enter Your Username</h2>
            <input type="text" id="username-input" placeholder="Username" autofocus maxlength="20">
            <button id="username-button">Enter Chat</button>
            <div id="username-error"></div>
        </div>
    </div>

    <!-- Sidebar -->
    <div id="sidebar">
        <div id="room-selection">
            <label for="room-input">Room:</label>
            <input type="text" id="room-input" value="general" placeholder="Enter room name" disabled>
            <button id="join-room-button" disabled>Join</button>
        </div>
        <div id="user-list-container">
            <h2 id="user-list-header">Online Users</h2>
            <ul id="users">
                <!-- User list appears here -->
            </ul>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div id="chat-container">
         <div id="chat-header">
            <span id="current-room-name">Not in a room</span>
            <span id="sound-toggle" class="sound-off" title="Toggle sound notifications">Muted</span>
         </div>
        <ul id="messages">
            <!-- Messages appear here -->
        </ul>
        <div id="typing-indicator"></div>
         <emoji-picker style="display: none;"></emoji-picker> <!-- Hidden by default -->
        <form id="input-area" action="">
            <button type="button" id="emoji-button" title="Pick emoji" disabled>ðŸ˜€</button>
            <input id="input" autocomplete="off" placeholder="Type a message..." disabled />
            <button type="submit" id="send-button" disabled>Send</button>
        </form>
    </div>

    <!-- Notification Sound -->
    <audio id="notification-sound" src="https://cdn.freesound.org/previews/253/253886_313295-lq.mp3" preload="auto"></audio>


    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <script>
        // --- Configuration & Constants ---
        const TYPING_TIMER_LENGTH = 800; // ms
        const TYPING_DISPLAY_TIMER_LENGTH = 2500; // ms
        const HASH_COLOR_COUNT = 18; // Number of distinct background colors for avatars

        // --- DOM Elements ---
        const messagesContainer = document.getElementById('messages');
        const messageInputForm = document.getElementById('input-area');
        const messageInput = document.getElementById('input');
        const sendButton = document.getElementById('send-button');
        const userList = document.getElementById('users');
        const userListHeader = document.getElementById('user-list-header');
        const typingIndicator = document.getElementById('typing-indicator');
        const usernameModal = document.getElementById('username-modal');
        const usernameInput = document.getElementById('username-input');
        const usernameButton = document.getElementById('username-button');
        const usernameError = document.getElementById('username-error');
        const roomInput = document.getElementById('room-input');
        const joinRoomButton = document.getElementById('join-room-button');
        const currentRoomNameSpan = document.getElementById('current-room-name');
        const emojiButton = document.getElementById('emoji-button');
        const emojiPicker = document.querySelector('emoji-picker');
        const soundToggle = document.getElementById('sound-toggle');
        const notificationSound = document.getElementById('notification-sound');


        // --- State Variables ---
        let currentUsername = null;
        let currentRoom = null;
        let isTyping = false;
        let lastTypingTime;
        let usersTyping = {}; // { username: timeoutId }
        let soundEnabled = false; // Sound off by default
        let isWindowFocused = true;


        // --- Socket.IO Connection ---
        const socket = io({
             reconnectionAttempts: 5,
             reconnectionDelay: 2000,
             timeout: 10000, // Connection timeout
        });

        // --- Utility Functions ---

        function getUserInitials(username) {
            if (!username) return '?';
            const parts = username.split(/[ _-]/); // Split by space, underscore, hyphen
            if (parts.length === 1) {
                return username.substring(0, 2).toUpperCase();
            } else {
                return (parts[0][0] + (parts[1][0] || '')).toUpperCase();
            }
        }

        function getAvatarColorClass(username) {
             // Simple hash function to get a somewhat consistent color based on username
             let hash = 0;
             if (!username) return 'avatar-color-0';
             for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
                hash = hash & hash; // Convert to 32bit integer
             }
             const index = Math.abs(hash) % HASH_COLOR_COUNT;
             return `avatar-color-${index}`;
        }

        function createUserAvatar(username) {
            const avatar = document.createElement('div');
            avatar.className = `user-avatar ${getAvatarColorClass(username)}`;
            avatar.textContent = getUserInitials(username);
            avatar.title = username; // Tooltip with full name
            return avatar;
        }

        function addMessage(data, isHistory = false) {
            const { msg, username, timestamp, type = 'user', room } = data;

            // Don't add messages from other rooms (can happen briefly during room change)
            if (room && room !== currentRoom) return;

            const messageElement = document.createElement('li');
            messageElement.classList.add(`message-${type}`); // user, system, status, error

            if (type === 'user') {
                 const messageContainer = document.createElement('div');
                 messageContainer.classList.add('message-container');

                 const isMyMsg = username === currentUsername;
                 messageContainer.classList.add(isMyMsg ? 'my-message' : 'other-message');

                 const avatarElement = createUserAvatar(username);

                 const messageContent = document.createElement('div');
                 messageContent.classList.add('message-content');

                 const metaSpan = document.createElement('span');
                 metaSpan.classList.add('message-meta');
                 metaSpan.textContent = `${username} - ${timestamp || ''}`;

                 const bubbleSpan = document.createElement('span');
                 bubbleSpan.classList.add('message-bubble');
                 bubbleSpan.innerHTML = formatMessageContent(escapeHTML(msg)); // Use innerHTML for potential formatting

                 messageContent.appendChild(metaSpan);
                 messageContent.appendChild(bubbleSpan);

                 messageContainer.appendChild(avatarElement); // Order is managed by CSS
                 messageContainer.appendChild(messageContent); // Order is managed by CSS

                 messageElement.appendChild(messageContainer);

                 // Play sound only for new, non-history messages from others when enabled and window blurred
                 if (!isHistory && !isMyMsg && soundEnabled && !isWindowFocused) {
                     playNotificationSound();
                 }

            } else { // System, Status, Error messages
                 messageElement.innerHTML = `<span class="message-text">${escapeHTML(msg)}</span> <span class="message-timestamp">${timestamp || ''}</span>`;
            }

            messagesContainer.appendChild(messageElement);

            // Scroll only if near the bottom or it's a message from the current user
            const shouldScroll = isHistory || (username === currentUsername) || (messagesContainer.scrollTop + messagesContainer.clientHeight >= messagesContainer.scrollHeight - 100);
            if (shouldScroll) {
                scrollToBottom();
            }
        }

        function loadMessageHistory(history) {
             messagesContainer.innerHTML = ''; // Clear existing messages
             if (history && history.length > 0) {
                addMessage({ type: 'system', msg: `--- Displaying last ${history.length} messages ---`, timestamp: '' });
                history.forEach(msgData => addMessage(msgData, true)); // Mark as history message
             } else {
                 addMessage({ type: 'system', msg: 'No previous messages in this room.', timestamp: '' });
             }
             scrollToBottom(); // Scroll after loading history
        }

        function updateUserList(usernames) {
            userList.innerHTML = ''; // Clear current list
            usernames.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase())); // Sort
            usernames.forEach(username => {
                const item = document.createElement('li');
                const avatar = createUserAvatar(username);
                const nameSpan = document.createElement('span');
                nameSpan.textContent = escapeHTML(username);
                item.appendChild(avatar);
                item.appendChild(nameSpan);
                if (username === currentUsername) {
                    // item.style.fontWeight = 'bold'; // Optional: highlight self
                }
                userList.appendChild(item);
            });
            userListHeader.textContent = `Online Users (${usernames.length})`;
        }

        function updateTypingIndicator() {
            const typingUsernames = Object.keys(usersTyping);
            if (typingUsernames.length === 0) {
                typingIndicator.textContent = '';
            } else if (typingUsernames.length === 1) {
                typingIndicator.textContent = `${escapeHTML(usersTyping[typingUsernames[0]])} is typing...`;
            } else if (typingUsernames.length === 2) {
                 typingIndicator.textContent = `${escapeHTML(usersTyping[typingUsernames[0]])} and ${escapeHTML(usersTyping[typingUsernames[1]])} are typing...`;
            } else {
                typingIndicator.textContent = 'Several people are typing...';
            }
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function escapeHTML(str) {
             if (typeof str !== 'string') return '';
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

         function formatMessageContent(text) {
            // Basic URL detection and linking
            const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            return text.replace(urlRegex, function(url) {
                return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: var(--link-color);">${url}</a>`;
            });
            // Could add markdown support here later
         }

        function enableChatInterface() {
            messageInput.disabled = false;
            sendButton.disabled = false;
            emojiButton.disabled = false;
            if (!currentRoom) { // Enable room joining only after username set
                roomInput.disabled = false;
                joinRoomButton.disabled = false;
                roomInput.focus();
            } else { // Enable message input only after joining a room
                 messageInput.focus();
            }
        }

        function disableChatInterface() {
            messageInput.disabled = true;
            sendButton.disabled = true;
            emojiButton.disabled = true;
            roomInput.disabled = true;
            joinRoomButton.disabled = true;
             emojiPicker.style.display = 'none'; // Hide picker if disabled
        }

        function playNotificationSound() {
             if (notificationSound.readyState >= 2) { // HAVE_CURRENT_DATA or more
                notificationSound.currentTime = 0; // Rewind first
                 notificationSound.play().catch(error => console.warn("Sound play failed:", error)); // Play might be blocked by browser
             }
        }

        function updateSoundToggleUI() {
             if (soundEnabled) {
                 soundToggle.classList.remove('sound-off');
                 soundToggle.classList.add('sound-on');
                 soundToggle.textContent = 'Sound ON';
                 soundToggle.title = 'Click to Mute Notifications';
             } else {
                 soundToggle.classList.remove('sound-on');
                 soundToggle.classList.add('sound-off');
                 soundToggle.textContent = 'Sound OFF';
                 soundToggle.title = 'Click to Unmute Notifications';
             }
        }

        // --- Event Listeners ---

        usernameButton.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            if (username) {
                currentUsername = username; // Tentatively set
                usernameError.textContent = '';
                usernameModal.style.display = 'none'; // Hide modal
                enableChatInterface(); // Enable room joining
                // Join the default room automatically or prompt
                joinRoom(roomInput.value || 'general');
            } else {
                usernameError.textContent = 'Please enter a valid username.';
            }
        });

        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                usernameButton.click(); // Trigger button click on Enter
            }
        });

        joinRoomButton.addEventListener('click', () => {
            const roomName = roomInput.value.trim();
            if (roomName && currentUsername) {
                 joinRoom(roomName);
            } else if (!currentUsername) {
                 alert("Please set your username first (refresh if needed).");
            } else {
                 alert("Please enter a room name.");
            }
        });

         roomInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                joinRoomButton.click();
            }
        });

        messageInputForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const messageText = messageInput.value.trim();
            if (messageText && currentUsername && currentRoom) {
                socket.emit('send_message', { msg: messageText });
                messageInput.value = '';
                if(isTyping) {
                     socket.emit('typing', { is_typing: false });
                     isTyping = false;
                }
                 messageInput.focus(); // Keep focus on input
            }
        });

        messageInput.addEventListener('input', () => {
            if (!currentUsername || !currentRoom) return;

            if (!isTyping) {
                isTyping = true;
                socket.emit('typing', { is_typing: true });
            }
            lastTypingTime = Date.now();

            setTimeout(() => {
                if (isTyping && (Date.now() - lastTypingTime >= TYPING_TIMER_LENGTH)) {
                    socket.emit('typing', { is_typing: false });
                    isTyping = false;
                }
            }, TYPING_TIMER_LENGTH);
        });

        emojiButton.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent closing if clicked again immediately
            emojiPicker.style.display = (emojiPicker.style.display === 'none' ? 'block' : 'none');
        });

        emojiPicker.addEventListener('emoji-click', event => {
            messageInput.value += event.detail.unicode;
            emojiPicker.style.display = 'none';
            messageInput.focus();
        });

         // Close emoji picker if clicking outside
         document.addEventListener('click', (event) => {
             if (emojiPicker.style.display !== 'none' && !emojiPicker.contains(event.target) && event.target !== emojiButton) {
                 emojiPicker.style.display = 'none';
             }
         });

         soundToggle.addEventListener('click', () => {
             soundEnabled = !soundEnabled;
             updateSoundToggleUI();
              // Try to play a short sound on enable to test/prompt for permission
             if (soundEnabled) {
                 playNotificationSound();
             }
         });

         window.addEventListener('focus', () => { isWindowFocused = true; });
         window.addEventListener('blur', () => { isWindowFocused = false; });


        // --- Socket.IO Handlers ---

        function joinRoom(roomName) {
             if (!currentUsername) return; // Should not happen if UI is correct
             console.log(`Attempting to join room: ${roomName} as ${currentUsername}`);
             // Clear previous room state visually before joining new one
             messagesContainer.innerHTML = '';
             userList.innerHTML = '';
             userListHeader.textContent = 'Online Users';
             typingIndicator.textContent = '';
             currentRoom = null; // Mark as not in room until confirmed
             currentRoomNameSpan.textContent = `Joining ${roomName}...`;
             disableChatInterface(); // Disable input while joining

             socket.emit('join_room', { username: currentUsername, room: roomName });
        }

        socket.on('connect', () => {
            console.log('Connected:', socket.id);
            // Re-enable username prompt if username isn't set (e.g., after disconnect)
            if (!currentUsername) {
                usernameModal.style.display = 'flex';
                disableChatInterface();
                usernameInput.focus();
            } else {
                // If we have a username and were in a room, try rejoining
                const roomToRejoin = roomInput.value || 'general'; // Use last entered or default
                console.log(`Reconnected. Attempting to rejoin room: ${roomToRejoin}`);
                joinRoom(roomToRejoin);
            }
        });

        socket.on('disconnect', (reason) => {
            console.log('Disconnected:', reason);
            addMessage({ type: 'error', msg: `Disconnected: ${reason}. Attempting to reconnect...`, timestamp: ''});
            userList.innerHTML = '<li><i>Disconnected</i></li>';
            userListHeader.textContent = 'Offline';
            typingIndicator.textContent = '';
            usersTyping = {};
            currentRoomNameSpan.textContent = "Disconnected";
            currentRoom = null; // Mark as not in a room
            disableChatInterface(); // Disable everything until reconnected
        });

        socket.on('connect_error', (err) => {
            console.error('Connection Error:', err);
            usernameError.textContent = `Connection Failed: ${err.message}`; // Show in modal if visible
            addMessage({ type: 'error', msg: `Connection failed: ${err.message}.`, timestamp: '' });
            disableChatInterface();
        });

        socket.on('room_joined', (data) => {
            const { username, room, history } = data;
            console.log(`Successfully joined room: ${room} as ${username}`);
            if (username === currentUsername) { // Ensure it's confirmation for us
                 currentRoom = room;
                 currentRoomNameSpan.textContent = `Room: ${room}`;
                 roomInput.value = room; // Update input field to current room
                 loadMessageHistory(history);
                 enableChatInterface(); // Fully enable chat now
                 messageInput.focus();
            } else {
                 // This shouldn't happen if logic is correct, but good to log
                 console.warn("Received room_joined confirmation for unexpected user:", username);
            }
        });

        socket.on('error', (data) => {
            console.error('Server Error:', data.msg);
             // If the error happened during room join attempt, re-enable join controls
            if (!currentRoom && currentUsername) {
                 enableChatInterface(); // Re-enable room join parts
                 currentRoomNameSpan.textContent = "Error Joining Room";
            }
            // Display error prominently
            addMessage({ type: 'error', msg: `Error: ${data.msg}`, timestamp: '' });
            // Show in modal as well if it's visible
            if (usernameModal.style.display === 'flex') {
                 usernameError.textContent = data.msg;
            }
        });

        socket.on('receive_message', (data) => {
            // Only process message if it's for the current room
            if (data.room === currentRoom) {
                addMessage(data);
                 // Clear typing indicator for the sender if they were typing
                if (data.username && usersTyping[data.username]) {
                    clearTimeout(usersTyping[data.username].timeoutId);
                    delete usersTyping[data.username];
                    updateTypingIndicator();
                }
            } else {
                 console.log("Received message for different room:", data.room, "Current:", currentRoom);
            }
        });

        socket.on('update_user_list', (data) => {
            // Only update list if it's for the current room
            if (data.room === currentRoom) {
                updateUserList(data.users);
            }
        });

        socket.on('user_typing', (data) => {
            // Only show typing if it's for the current room and not self
            if (data.room === currentRoom && data.username !== currentUsername) {
                 const { username, is_typing } = data;
                 if (is_typing) {
                     if (usersTyping[username]) {
                         clearTimeout(usersTyping[username].timeoutId); // Reset timer
                     }
                     usersTyping[username] = {
                         username: username, // Store username for display
                         timeoutId: setTimeout(() => {
                            delete usersTyping[username];
                            updateTypingIndicator();
                         }, TYPING_DISPLAY_TIMER_LENGTH)
                     };
                 } else {
                     if (usersTyping[username]) {
                         clearTimeout(usersTyping[username].timeoutId);
                         delete usersTyping[username];
                     }
                 }
                 updateTypingIndicator();
            }
        });

        // --- Initial Page Load ---
        function initializeApp() {
            disableChatInterface(); // Start disabled
            updateSoundToggleUI();
            // Generate CSS rules for avatar colors
            const styleSheet = document.createElement("style");
            let cssRules = "";
            const colors = [ // Predefined colors
                "#ff7f0e", "#1f77b4", "#2ca02c", "#d62728", "#9467bd",
                "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf",
                "#aec7e8", "#ffbb78", "#98df8a", "#ff9896", "#c5b0d5",
                "#c49c94", "#f7b6d2", "#c7c7c7"
             ];
            for(let i=0; i < HASH_COLOR_COUNT; i++) {
                cssRules += `.avatar-color-${i} { background-color: ${colors[i % colors.length]}; }\n`;
            }
            styleSheet.textContent = cssRules;
            document.head.appendChild(styleSheet);

             // Show username modal on load
            usernameModal.style.display = 'flex';
            usernameInput.focus();
        }

        initializeApp();

    </script>
</body>
</html>
