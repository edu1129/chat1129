<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banana Chat üçå</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f4f7f6;
            --primary-color: #ffcc29; /* Banana Yellow */
            --secondary-color: #4a4a4a;
            --accent-color: #6e45e2;
            --text-color: #333;
            --border-color: #e0e0e0;
            --message-bg: #ffffff;
            --my-message-bg: #e2ffc7; /* Light green for own messages */
            --system-message-color: #888;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden; /* Prevent body scroll */
            transition: background-color 0.3s ease; /* Smooth transition */
        }

        .chat-container {
            display: flex;
            flex-direction: row;
            width: 100%;
            height: 100%;
            background-color: #fff;
            box-shadow: var(--shadow);
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Sidebar for Users */
        .sidebar {
            width: 200px;
            background: linear-gradient(135deg, var(--primary-color), #ffd65a);
            border-right: 1px solid var(--border-color);
            padding: 20px 15px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            transition: width 0.3s ease;
        }

        .sidebar h2 {
            color: var(--secondary-color);
            font-weight: 600;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(0,0,0,0.1);
            padding-bottom: 10px;
            text-align: center;
            font-size: 1.1em;
        }

        #user-list {
            list-style: none;
            padding: 0;
            flex-grow: 1; /* Takes remaining space */
        }

        #user-list li {
            padding: 8px 5px;
            margin-bottom: 5px;
            border-radius: 6px;
            font-size: 0.9em;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        #user-list li:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .user-color-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .nickname-section {
            margin-top: auto; /* Pushes to bottom */
            padding-top: 15px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        #nickname-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        #nickname-input:focus {
             outline: none;
             border-color: var(--accent-color);
             box-shadow: 0 0 0 2px rgba(110, 69, 226, 0.2);
        }
        #your-info {
            font-size: 0.8em;
            color: var(--secondary-color);
            text-align: center;
            margin-top: 5px;
            word-break: break-all;
        }


        /* Main Chat Area */
        .main-chat {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color);
        }

        /* Message Area */
        #messages {
            list-style-type: none;
            margin: 0;
            padding: 20px;
            flex-grow: 1; /* Takes available space */
            overflow-y: auto; /* Enable scrolling for messages */
            scroll-behavior: smooth; /* Smooth scroll on new messages */
        }

        #messages li {
            padding: 12px 18px;
            margin-bottom: 12px;
            border-radius: var(--border-radius);
            max-width: 75%;
            word-wrap: break-word;
            opacity: 0; /* Start hidden for animation */
            transform: translateY(10px); /* Start slightly lower */
            animation: messageFadeIn 0.4s ease-out forwards;
            position: relative; /* For sender pseudo-element */
        }

        #messages li:last-child {
             margin-bottom: 0; /* No margin for the very last message */
        }


        @keyframes messageFadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #messages li.message-other {
            background-color: var(--message-bg);
            margin-right: auto; /* Align left */
             border-bottom-left-radius: 4px; /* Speech bubble effect */
        }
         #messages li.message-my {
            background-color: var(--my-message-bg);
            margin-left: auto; /* Align right */
            border-bottom-right-radius: 4px; /* Speech bubble effect */
         }

         .message-sender {
            display: block;
            font-size: 0.8em;
            font-weight: 600;
            margin-bottom: 4px;
            opacity: 0.9;
         }

         #messages li.message-system {
            background-color: transparent;
            color: var(--system-message-color);
            font-style: italic;
            font-size: 0.85em;
            text-align: center;
            width: 100%;
            max-width: 100%;
            padding: 5px 0;
            animation: none; /* No fade for system messages */
            opacity: 1;
            transform: none;
         }
         #messages li.message-system.join {
            color: #28a745; /* Green for joins */
         }
          #messages li.message-system.leave {
            color: #dc3545; /* Red for leaves */
         }
          #messages li.message-system.nick_change {
            color: #6f42c1; /* Purple for nick changes */
         }

        /* Typing Indicator */
        #typing-indicator {
            padding: 0 20px 5px; /* Position above input */
            height: 20px; /* Reserve space */
            font-size: 0.85em;
            color: var(--system-message-color);
            font-style: italic;
            min-height: 20px; /* Prevent layout shift */
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #typing-indicator.visible {
             opacity: 1;
        }
        #typing-indicator span {
            display: inline-block;
            animation: typingDots 1.4s infinite;
        }
         #typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
         #typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingDots {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }


        /* Input Area */
        #form {
            display: flex;
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            background-color: #ffffff; /* White background for input */
        }

        #input {
            flex-grow: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-right: 10px;
            font-size: 1em;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        #input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(110, 69, 226, 0.15);
        }

        #form button {
            padding: 12px 25px;
            background: linear-gradient(135deg, var(--accent-color), #8a5fff);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: background 0.3s ease, transform 0.1s ease;
        }

        #form button:hover {
            background: linear-gradient(135deg, #5a34d1, #7b4af1);
        }
         #form button:active {
             transform: scale(0.98);
         }


         /* Responsive adjustments */
         @media (max-width: 768px) {
            body {
                flex-direction: column; /* Stack elements vertically */
            }
            .chat-container {
                 flex-direction: column;
                 height: 100%; /* Take full viewport height */
            }

            .sidebar {
                width: 100%; /* Full width */
                height: auto; /* Adjust height based on content */
                max-height: 30vh; /* Limit sidebar height */
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                flex-direction: row; /* Layout items horizontally */
                align-items: flex-start; /* Align items top */
                padding: 10px 15px;
                overflow-x: auto; /* Horizontal scroll if needed */
            }

            .sidebar h2 {
                margin-bottom: 0;
                margin-right: 15px; /* Space between title and list */
                padding-bottom: 5px;
                border-bottom: none;
                white-space: nowrap; /* Prevent title wrapping */
            }

             #user-list {
                 display: flex; /* Horizontal user list */
                 flex-direction: row;
                 flex-wrap: nowrap; /* Don't wrap users */
                 overflow-x: auto; /* Allow horizontal scroll for users */
                 flex-grow: 0; /* Don't take remaining space */
                 margin-right: 15px;
             }
             #user-list li {
                margin-bottom: 0;
                margin-right: 10px; /* Space between users */
                padding: 5px 8px;
                 white-space: nowrap; /* Keep username on one line */
            }
            .nickname-section {
                margin-top: 0;
                margin-left: auto; /* Push nickname input to the right */
                padding-top: 0;
                border-top: none;
                display: flex;
                align-items: center; /* Align input and info vertically */
                flex-shrink: 0; /* Prevent shrinking */
            }
            #nickname-input {
                 width: 120px; /* Fixed width for nickname input */
                 margin-bottom: 0;
                 margin-right: 10px;
            }
             #your-info {
                 margin-top: 0;
                 font-size: 0.75em;
             }

            .main-chat {
                height: calc(100% - 30vh); /* Adjust height based on sidebar max-height */
                 flex-grow: 1; /* Ensure it fills remaining space */
            }
            #messages {
                padding: 15px;
            }
             #messages li {
                 max-width: 85%;
             }
             #form {
                padding: 10px 15px;
            }
            #input { padding: 10px 12px; font-size: 0.95em;}
            #form button { padding: 10px 20px; font-size: 0.95em; }
         }

         @media (max-width: 480px) {
              .sidebar {
                  max-height: 25vh; /* Slightly smaller sidebar on very small screens */
                  padding: 8px 10px;
              }
              .sidebar h2 { font-size: 1em; margin-right: 10px;}
              #user-list li { padding: 4px 6px; font-size: 0.8em; }
              .nickname-section { flex-direction: column; align-items: flex-end; }
              #nickname-input { width: 100px; margin-right: 0; margin-bottom: 3px;}
              #your-info { font-size: 0.7em; }
         }

    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h2>Online Users</h2>
            <ul id="user-list">
                <!-- User list will be populated here -->
            </ul>
            <div class="nickname-section">
                 <input id="nickname-input" autocomplete="off" placeholder="Set Nickname" maxlength="15" />
                 <div id="your-info">Connecting...</div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-chat">
            <ul id="messages">
                <!-- Messages will appear here -->
            </ul>
            <div id="typing-indicator">
                 <!-- Typing indicator like "User is typing..." -->
                 <!-- Using spans for dot animation -->
                 <span class="dot"></span><span class="dot"></span><span class="dot"></span>
            </div>
            <form id="form" action="">
                <input id="input" autocomplete="off" placeholder="Type a message..." />
                <button>Send</button>
            </form>
        </div>
    </div>

    <!-- Include Socket.IO client library -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // DOM Elements
        const messages = document.getElementById('messages');
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const userList = document.getElementById('user-list');
        const nicknameInput = document.getElementById('nickname-input');
        const yourInfoDiv = document.getElementById('your-info');
        const typingIndicator = document.getElementById('typing-indicator');

        let myInfo = {}; // Store client's own info (id, nickname, color)
        let typingTimeout;
        let isTyping = false;
        const currentlyTyping = new Set(); // Users currently typing

        // --- Helper Functions ---
        function addMessageToList(item, isSystem = false) {
            messages.appendChild(item);
            // Smart scroll: only scroll down if user is already near the bottom
            const scrollThreshold = 100; // Pixels from bottom
            const isScrolledToBottom = messages.scrollHeight - messages.clientHeight <= messages.scrollTop + scrollThreshold;

            if (isScrolledToBottom || isSystem) {
                 // Use smooth scroll only if the browser supports it well with frequent updates
                 // messages.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
                 // Direct jump might be better for performance with many messages
                 messages.scrollTop = messages.scrollHeight;
            }
        }

        function displaySystemMessage(msgData) {
             const item = document.createElement('li');
             item.textContent = msgData.text;
             item.classList.add('message-system', msgData.type); // Add type class for specific styling
             addMessageToList(item, true); // Always scroll for system messages
        }

         function displayChatMessage(msgData) {
             const item = document.createElement('li');

             // Create sender element
             const senderSpan = document.createElement('span');
             senderSpan.textContent = msgData.sender;
             senderSpan.className = 'message-sender';
             senderSpan.style.color = msgData.color; // Use sender's color

             item.appendChild(senderSpan);
             item.appendChild(document.createTextNode(msgData.text)); // Append message text

             // Add class based on whether it's the user's own message
             if (msgData.id === socket.id) {
                 item.classList.add('message-my');
             } else {
                 item.classList.add('message-other');
             }

             addMessageToList(item);
        }

        function updateTypingIndicator() {
            const typingUsers = Array.from(currentlyTyping);
            if (typingUsers.length === 0) {
                typingIndicator.textContent = '';
                typingIndicator.classList.remove('visible');
            } else {
                let text;
                 if (typingUsers.length === 1) {
                     text = `${typingUsers[0]} is typing...`;
                 } else if (typingUsers.length === 2) {
                     text = `${typingUsers[0]} and ${typingUsers[1]} are typing...`;
                 } else {
                     text = `${typingUsers.slice(0, 2).join(', ')} and others are typing...`;
                 }
                 typingIndicator.textContent = text;
                 typingIndicator.classList.add('visible');
                 // Restart dot animation if needed (use textContent instead of spans for simplicity now)
            }
        }


        // --- Socket Event Listeners ---

        // Receive own info on connect
         socket.on('your info', (info) => {
            myInfo = info;
            nicknameInput.value = info.nickname; // Pre-fill nickname input
            yourInfoDiv.textContent = `You are ${info.nickname}`;
            yourInfoDiv.style.color = info.color; // Optional: Color the text
         });

        // Handle incoming chat messages
        socket.on('chat message', (msgData) => {
            displayChatMessage(msgData);
            // If someone else sent a message, remove them from typing indicator
            currentlyTyping.delete(msgData.sender);
            updateTypingIndicator();
        });

        // Handle system messages (join, leave, nick change)
         socket.on('system message', (msgData) => {
             displaySystemMessage(msgData);
         });

        // Update online user list
         socket.on('update user list', (users) => {
             userList.innerHTML = ''; // Clear current list
             users.forEach(user => {
                const item = document.createElement('li');
                const colorDot = document.createElement('span');
                colorDot.className = 'user-color-dot';
                colorDot.style.backgroundColor = user.color;
                item.appendChild(colorDot);
                item.appendChild(document.createTextNode(user.nickname));
                if (user.nickname === myInfo.nickname) {
                    item.style.fontWeight = 'bold'; // Highlight own username
                }
                userList.appendChild(item);
             });
         });

        // Handle typing events from others
        socket.on('typing', (data) => {
             currentlyTyping.add(data.nickname);
             updateTypingIndicator();
        });

        socket.on('stop typing', (data) => {
             currentlyTyping.delete(data.nickname);
             updateTypingIndicator();
        });

        // --- DOM Event Listeners ---

        // Send message on form submit
        form.addEventListener('submit', (e) => {
            e.preventDefault(); // Prevent page reload
            if (input.value) {
                socket.emit('chat message', input.value);
                input.value = ''; // Clear input field
                // Stop typing immediately after sending
                 clearTimeout(typingTimeout);
                 if (isTyping) {
                    socket.emit('stop typing');
                    isTyping = false;
                 }
            }
        });

        // Handle nickname change on input blur (losing focus) or Enter
        nicknameInput.addEventListener('keypress', (e) => {
             if (e.key === 'Enter') {
                 e.preventDefault(); // Prevent form submission if inside a form
                 const newNickname = nicknameInput.value.trim();
                 if (newNickname && newNickname !== myInfo.nickname) {
                     socket.emit('change nickname', newNickname);
                 }
                 nicknameInput.blur(); // Remove focus after Enter
             }
        });
         nicknameInput.addEventListener('blur', () => {
              const newNickname = nicknameInput.value.trim();
              if (newNickname && newNickname !== myInfo.nickname) {
                  socket.emit('change nickname', newNickname);
              } else {
                 // If nickname didn't change or is empty, revert to current nickname
                 nicknameInput.value = myInfo.nickname || '';
              }
         });

        // Typing indicator logic
         input.addEventListener('input', () => {
            if (!isTyping) {
                isTyping = true;
                socket.emit('typing');
            }
             clearTimeout(typingTimeout);
             typingTimeout = setTimeout(() => {
                 socket.emit('stop typing');
                 isTyping = false;
             }, 2000); // Consider typing stopped after 2 seconds of inactivity
         });

         // Initial message
         window.addEventListener('load', () => {
             displaySystemMessage({ text: 'Welcome to Banana Chat! üçå', type: 'welcome'});
         });

    </script>
</body>
</html>
